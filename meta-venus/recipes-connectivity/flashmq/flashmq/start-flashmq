# Although FlashMQ use this key nowadays, it is still called mosquitto.

keydir=/data/keys
cert=$keydir/mosquitto.crt
key=$keydir/mosquitto.key

mkdir -p $keydir
# note: older devices have 700 as permission, always change it so
# the flashmq user can access it.
chown 755 /data/keys

if ! openssl rsa -check -noout -in $key ||
   ! openssl verify -CAfile $cert $cert ||
   ! openssl x509 -noout -checkend 31536000 -in $cert; then
    openssl req -subj /CN=venus.local -newkey rsa:2048 -nodes \
            -keyout $key -x509 -days 36524 -out $cert
fi

chmod 400 $key
chown flashmq $key

exec softlimit -d 150000000 -s 10000000 -a 150000000 setuidgid flashmq /usr/bin/flashmq
